<!DOCTYPE html>  <html> <head>   <title>queue-flow.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               queue-flow.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>queue-flow Copyright (C) 2012 by David Ellis</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Construct the <code>q</code> environment and return the <code>q</code> accessor/constructor object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">qEnv</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>List of named queues</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">namedQueues</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>For browser compatibility, masquerade <code>setTimeout</code> as <code>process.nextTick</code>
This is to work around an issue with Node 0.6 where <code>setTimeout(someFunc, 0)</code>
doesn't behave like <code>process.nextTick</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">process</span> <span class="o">||</span> <span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span> <span class="o">=</span> <span class="nx">process</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">||</span> <span class="nx">setTimeout</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Determines if this queue has a name, and either finds or returns said named queue,
or decides it's an unnamed queue and returns said queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">q</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">,</span> <span class="nx">qType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">nameOrArray</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">nameOrArray</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Q</span> <span class="o">||</span> <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">nameOrArray</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">qType</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">nameOrArray</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">,</span> <span class="nx">qType</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">nameOrArray</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">nameOrArray</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">,</span> <span class="nx">qType</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Q</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">qType</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>exists</code> returns whether or not a named queue exists in
this <code>qEnv</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">exists</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">exists</span><span class="p">(</span><span class="nx">queueName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queueName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queueName</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>makeAsync</code> and <code>makeSync</code> helper methods allow a more fluent API to force
async or sync methods, suggested by a colleague, and fits better in the
<code>queue-flow</code> API.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">makeAsync</span><span class="p">(</span><span class="nx">qfMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">qfMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
        <span class="p">})</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">makeSync</span><span class="p">(</span><span class="nx">qfMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">qfMethod</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
        <span class="p">})</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>isAsync</code> checks for the <code>async</code> property and if it doesn't exist, and the <code>sync</code> property
doesn't exist, then it attempts to "guess" whether a function is asynchronous (based on
the number of named arguments). Further checks could be done (such as scouring the source
code of the function for a <code>return</code> statement) but are performance cost-prohibiitive, and
the developer can use the <code>async</code> method to clarify it is actually async in that case.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">isAsync</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">asyncArgLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nx">async</span><span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">method</span><span class="p">.</span><span class="nx">sync</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">asyncArgLength</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Expose the <code>Q</code> constructor function (below) so third parties can extend its prototype</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">Q</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Create a new queue-flow environment/namespace</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">ns</span> <span class="o">=</span> <span class="nx">qEnv</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>tuple</code> converts an object into an array of arrays. The arrays are tuples of the
key-value pairs from the object, so they can be processed individually in a queue-flow
if desired, rather than considering the whole object as a single item in the queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">q</span><span class="p">.</span><span class="nx">tuple</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">tuple</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">outArr</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">outArr</span><span class="p">.</span><span class="nx">concat</span><span class="p">([[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]]]);</span> <span class="p">},</span> <span class="p">[]);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The <code>Q</code> constructor function, which either uses the supplied queueing engine, or
uses the built-in in-memory engine.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">,</span> <span class="nx">qType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">qType</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">qType</span> <span class="o">&amp;&amp;</span> <span class="nx">qType</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="o">?</span> <span class="nx">qType</span> <span class="o">:</span> <span class="nx">Q</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Private variables, the handlers and actual queue array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">eventHandlers</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">nameOrArray</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">?</span> <span class="nx">nameOrArray</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">handlerBusy</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">closeAfterHandler</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">recentlyEmptied</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Privileged methods</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>on</code> registers event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">eventHandlers</span><span class="p">)</span> <span class="nx">eventHandlers</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">?</span> <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>
      <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><code>fire</code> executes the event handlers, passing along whatever arguments given to it
minus the event name indicator, of course. If any handler returns false, it indicates
so, indiating to the method firing the event to cancel.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">fire</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fire</span><span class="p">(</span><span class="nx">eventName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">newArgs</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">eventHandlers</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">handler</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">newArgs</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><code>clear</code> clears all event handlers from the specified event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">clear</span><span class="p">(</span><span class="nx">eventName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><code>setHandler</code> defines the special function to call to process the queue
assumed to be ready initially, when called marked busy, call provided callback to
mark ready again.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setHandler</span><span class="p">(</span><span class="nx">handlerFunc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handler</span> <span class="o">=</span> <span class="nx">handlerFunc</span><span class="p">;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">handlerCallback</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>The <code>handlerCallback</code> is provided to the handler along with the dequeued value.
If there is more work to be done, it continues, otherwise is marks the handler
as ready for when the data next arrives</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">handlerCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handlerCallback</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">handlerBusy</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">queue</span> <span class="o">&amp;&amp;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">handler</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">handlerBusy</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">handlerCallback</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">handler</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">recentlyEmptied</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">);</span>
          <span class="nx">recentlyEmptied</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">closeAfterHandler</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Inserts a specified value into the queue, if allowed by the event handlers, and
calls the special handler function, if it's ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">recentlyEmptied</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="nx">values</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">handlerCallback</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Signals that the queue is being destroyed and then, if allowed, destroys it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">close</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">handlerBusy</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">closeAfterHandler</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
        <span class="kd">function</span> <span class="nx">flushQueue</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">queue</span> <span class="o">&amp;&amp;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">handler</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">flushQueue</span><span class="p">));</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">tempHandler</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
              <span class="nx">handler</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
              <span class="nx">eventHandlers</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
              <span class="nx">queue</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
              <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queue</span><span class="p">]</span> <span class="o">===</span> <span class="k">this</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queue</span><span class="p">];</span>
              <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
              <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">tempHandler</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">tempHandler</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">));</span>
              <span class="p">}</span>
            <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">flushQueue</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Kills the queue (and all sub-queues) immediately, no possibility of blocking
with an event handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">kill</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">kill</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="s1">&#39;kill&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">tempHandler</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
      <span class="nx">handler</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="nx">eventHandlers</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="nx">queue</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queue</span><span class="p">]</span> <span class="o">===</span> <span class="k">this</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">queue</span><span class="p">];</span>
      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">tempHandler</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tempHandler</span><span class="p">(</span><span class="s1">&#39;kill&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Ignore all of this and replace with a custom handler object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">qType</span> <span class="o">&amp;&amp;</span> <span class="nx">qType</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">qType</span><span class="p">(</span><span class="nx">nameOrArray</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Start processing the queue after the next JS event loop cycle and return the queue
object to the remaining code.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">handlerCallback</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><code>Q</code> prototype methods</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><code>as</code> names or aliases the given queue</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">as</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">as</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">namedQueues</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><code>load</code> is a simpler wrapper around <code>push</code> that takes a single array
and covers up the relatively nasty <code>apply</code> mechanism (when dealing with
queue-flow's particular object model</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">array</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Getting the queue-flow object requires q('nameHere')
and q('nameHere').push.apply(q('nameHere'), array) is ugly and verbose</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><code>each</code> creates an output queue that simply copies the input queue results,
while also passing these results to the provided callback for side-effect
purposes. The output queue is so the data is not destroyed by the <code>each</code>
method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">[</span><span class="nx">value</span><span class="p">]();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">outQueue</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">eachAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">each</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">eachSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">each</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><code>setResult</code> is a helper function useful for several of the Q prototype methods
to set their result in a regular fashion</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">setResult</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">setResult</span><span class="p">(</span><span class="nx">setter</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setter</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><code>inOut</code> is a helper function useful for several of the Q prototype methods that
take an input queue and produce an output queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">inOut</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">inOut</span><span class="p">(</span><span class="nx">outQueue</span><span class="p">,</span> <span class="nx">setter</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">[</span><span class="nx">value</span><span class="p">]();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">setter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span> <span class="nx">next</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">setResult</span><span class="p">(</span><span class="nx">setter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">outQueue</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><code>map</code> creates an output queue, and executes
the given callback on each value, pushing the
result into the output queue before continuing
to process the input queue</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">map</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">inOut</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)(</span><span class="nx">outQueue</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">mapSetter</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mapAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mapSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><code>reduce</code> creates an output variable, and executes once upstream has
<code>close()</code>d, it does one of three things, depending on the value of
<code>last</code>: if undefined it returns an anonymous queue and pushes that
sole result into the queue and closes it immediately. If <code>last</code> is
a string, it pushes that result into the named queue. If <code>last</code> is
a function, it does not create a queue and instead calls <code>last</code> with
the <code>out</code> value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">reduce</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">,</span> <span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">initial</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="nx">last</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">last</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">q</span><span class="p">(</span><span class="nx">last</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">out</span><span class="p">),</span> <span class="nx">outQueue</span><span class="p">[</span><span class="nx">value</span><span class="p">]();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
          <span class="p">},</span> <span class="nx">next</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">out</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">outQueue</span> <span class="o">||</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduceAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduceSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><code>filter</code> creates an output queue, and executes
the given callback on each value, pushing the
original value <em>only</em> if the callback returns true.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">inOut</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)(</span><span class="nx">outQueue</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">filterSetter</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filterAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filter</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filterSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><code>branch</code> creates several named output queues and pushes the input queue
values into one of those queues based on the return value of the callback
(the return value is the name of the queue it belongs to)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">branch</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">branch</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">q</span><span class="p">(</span><span class="nx">queue</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">q</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">},</span> <span class="nx">next</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">q</span><span class="p">(</span><span class="nx">queue</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">q</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">branchAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">branch</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">branchSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">branch</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p><code>everySome</code> helper function that is used to implement <code>Q.prototype.every</code>
and <code>Q.prototype.some</code>, similar to <code>reduce</code>, the behavior of <code>everySome</code>
will change whether <code>last</code> is a function, a string, or falsy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">everySome</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">everySome</span><span class="p">(</span><span class="nx">polarity</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="kd">function</span> <span class="nx">shortCircuit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">next</span><span class="p">)</span> <span class="nx">next</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">!</span><span class="nx">polarity</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="nx">last</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">last</span><span class="p">(</span><span class="o">!</span><span class="nx">polarity</span><span class="p">);</span> <span class="c1">// Reverse the polarity on the deflector shield!</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">q</span><span class="p">(</span><span class="nx">last</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="o">!</span><span class="nx">polarity</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">shortCircuit</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="nx">last</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">last</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
              <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">q</span><span class="p">(</span><span class="nx">last</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">next</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">shortCircuit</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">last</span><span class="p">)</span> <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="nx">last</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">last</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">last</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">q</span><span class="p">(</span><span class="nx">last</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">polarity</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">outQueue</span> <span class="o">||</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><code>every</code> returns true only if the callback has returned true every time. Immediately returns false
when false and closes the input queue in this event. A specialization of the <code>reduce</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">every</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">every</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">everySome</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">)();</span> <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">everyAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">every</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">everySync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">every</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><code>some</code> returns true only if the callback has returned true at least once. Immediately returns true
when true and closes the input queue in this event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">some</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">some</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">everySome</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">last</span><span class="p">)();</span> <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">someSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">some</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">someAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">some</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><code>toArray</code> returns an array from the given queue. A specialization of the <code>reduce</code> method.
Has the same three behaviors depending on the type of value <code>last</code> is, function, string, or
falsy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cumm</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cumm</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">cumm</span><span class="p">;</span>
    <span class="p">},</span> <span class="nx">last</span><span class="p">,</span> <span class="p">[]);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p><code>flatten</code> takes an input queue and produces an output queue of values that are not arrays. Any
array encountered is split and enqueued into the new queue recursively, unless given a depth to
flatten to (<code>true</code> == 1 in this case). Intended to be nearly identical to underscore's <code>flatten</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="kd">function</span> <span class="nx">processValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">currDepth</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">depth</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">depth</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">depth</span> <span class="o">==</span> <span class="nx">currDepth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">processValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">currDepth</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">[</span><span class="nx">value</span><span class="p">]();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">processValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">outQueue</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p><code>exec</code> is a slightly modified version of <code>map</code> that takes the input value, and if it is an
array, provides each value as an independent argument to the provided callback. It also assumes
the method returns a correct result and throws an error, or if async calls the callback with two
arguments, considered to be <code>error</code> and <code>value</code>, in that order, which matches most of the
Node.js API callbacks. A second parameter can also be set to determine what <code>exec</code> does when
an error is returned. If not set, <code>exec</code> simply ignores the error and value and processes the
next item in the queue. If set to <code>true</code>, it kills the queue at this point. If set to a function,
it kills the queue and calls the function with the error and value. If set to a string, it
passes the error and value into a queue of the same name and continues processing the rest of
the queue. If there was an error, for useful debugging the original params passed to exec are
also provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">exec</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">onError</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">qType</span><span class="p">();</span>
    <span class="kd">function</span> <span class="nx">shortCircuit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nx">next</span><span class="p">)</span> <span class="nx">next</span><span class="p">();</span> <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">ercb</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">onError</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// false or undefined, catches `undefined`s `instanceof` doesn&#39;t like</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">onError</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">shortCircuit</span><span class="p">);</span>
          <span class="nx">onError</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">onError</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">q</span><span class="p">(</span><span class="nx">onError</span><span class="p">).</span><span class="nx">push</span><span class="p">([</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">value</span><span class="p">]);</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">onError</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">q</span><span class="p">(</span><span class="nx">onError</span><span class="p">).</span><span class="nx">push</span><span class="p">([</span><span class="nx">error</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">value</span><span class="p">]);</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// &#39;truthy&#39; value</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">shortCircuit</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">[</span><span class="nx">value</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outQueue</span><span class="p">[</span><span class="nx">value</span><span class="p">]();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">isAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">value</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ercb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">value</span><span class="p">));</span>
          <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">ercb</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">ercb</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">outQueue</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">execAsync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeAsync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span><span class="p">);</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">execSync</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeSync</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exec</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p><code>chain</code> is a simple application of <code>branch</code> when you always want to branch to the same queue</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Q</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">chain</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">chain</span><span class="p">(</span><span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">branch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">queue</span><span class="p">;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="k">return</span> <span class="nx">q</span><span class="p">;</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>If in a CommonJS environment like Node.js, export queue-flow</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="nx">module</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">q</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 