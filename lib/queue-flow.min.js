// queue-flow Copyright (C) 2012 by David Ellis
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// Construct the `q` environment and return the `q` accessor/constructor object
var q=function e(){function n(e,i){if(typeof e=="string"){if(!t[e]||!(t[e]instanceof n.defaultQ||t[e]instanceof i))t[e]=new r(e,i||n.defaultQ);return t[e]}return e instanceof Array?new r(e,i||n.defaultQ):new r(undefined,i||n.defaultQ)}function r(e,i){this.qType=!!i&&i instanceof Function?i:r;var s={},o=e instanceof Array?e:[],u=undefined,a=!1,f=!1;this.on=function(t,n){return s||(s={}),s[t]=s[t]instanceof Array?s[t]:[],s[t].push(n),this}.bind(this),this.fire=function(t){var r=Array.prototype.slice.call(arguments,1,arguments.length-1),i=arguments[arguments.length-1]instanceof Function?arguments[arguments.length-1]:function(){};if(!s)i(!1);else if(s[t]){var o=s[t].length,u=0,a=!0;s[t].forEach(function(e,t){if(!t instanceof Function)return u++;if(n.isAsync(t,e.length+1))e.push(function(e){e===!1&&(a=e),u++,o==u&&i(a)}),t.apply(this,e);else{var r=t.apply(this,e);r===!1&&(a=r),u++,o==u&&i(a)}}.bind(this,r))}else i(!0)}.bind(this),this.clear=function(t){return s[t]=[],this}.bind(this),this.setHandler=function(t){return u=t,a||process.nextTick(l.bind(this)),this}.bind(this);var l=function h(e){e instanceof Function&&e(),!a&&o&&o.length>0?(a=!0,this.fire("pull",o[0],function(e){e&&u instanceof Function&&process.nextTick(function(){u.bind(this,o.shift(),function(e){a=!1,h.bind(this)(e)}.bind(this))()}.bind(this))}.bind(this))):!a&&!f&&(this.fire("empty"),f=!0)};this.push=function(t){f=!1;var n=Array.prototype.slice.call(arguments,0);return this.fire("push",n,function(e){e&&(Array.prototype.push.apply(o,n),a||process.nextTick(l.bind(this)))}.bind(this)),this}.bind(this),this.close=function(){return this.fire("close",function(e){if(e){this.clear("push"),this.on("push",function(){return!1});var n=function(){var e=u;u=undefined,s=undefined,o=undefined,Object.keys(t).forEach(function(e){t[e]===this&&delete t[e]}.bind(this)),delete this,e instanceof Function&&process.nextTick(e.bind(null,"close"))};o&&!o.length&&process.nextTick(n.bind(this)),o&&o.length&&(this.clear("empty"),this.on("empty",n.bind(this)))}}.bind(this)),this}.bind(this),this.kill=function(){this.fire("kill");var n=u;u=undefined,s=undefined,o=undefined,Object.keys(t).forEach(function(e){t[e]===this&&delete t[e]}.bind(this)),delete this,n instanceof Function&&n("kill")}.bind(this);if(i&&i instanceof Function&&i!==r){var c=new i(e);return c.namedQueues=t,c}return a||process.nextTick(l.bind(this)),o.length>0&&this.on("empty",this.close.bind(this)),this}function o(e,t){!t||t()}function u(e,t,r,i,s,u){s?!t||(t instanceof Function?(this.setHandler(o),t(s,u,i)):typeof t=="string"?r(function(){n(t).push([s,u,i])}):this.setHandler(o)):r(function(){e.push(u)})}function a(e,t,r){var i=new this.qType;return this.setHandler(function(s,o){function a(t){if(e=="async"||e!="sync"&&n.isAsync(s,t.length+1))t.push(u.bind(this,i,r,o,s)),s.apply(this,t);else try{u(i,r,o,s,undefined,s.apply(this,t))}catch(a){u(i,r,o,s,a)}}if(!o)return i[s]();if(!(s instanceof Function))return u(i,r,o,s,new Error("Not a function"),undefined);if(t instanceof Function&&n.isAsync(t,2))t(s,function(){a.bind(this)(Array.prototype.slice.call(arguments,0))});else if(t instanceof Function)try{var f=t(s);f=f instanceof Array?f:[f],a.bind(this)(f)}catch(l){u.bind(this)(i,r,o,s,l)}else t instanceof Array?a.bind(this)(t):a.bind(this)([t])}.bind(this)),i}if(!process||!process.nextTick)process=process||{},process.nextTick=process.nextTick||setTimeout;var t={};n.Q=r,n.defaultQ=r,n.ns=e,n.exists=function(n){return!!t[n]&&typeof t[n]=="object"},n.makeAsync=function(t){return function(){return t.apply(this,Array.prototype.slice.call(arguments,0).map(function(e){return e instanceof Function&&(e.async=!0),e}))}},n.makeSync=function(t){return function(){return t.apply(this,Array.prototype.slice.call(arguments,0).map(function(e){return e instanceof Function&&(e.sync=!0),e}))}},n.isAsync=function(t,n){return t.async||!t.sync&&t.length==n},n.tuple=function(t){return Object.keys(t).reduce(function(e,n){return e.concat([[n,t[n]]])},[])},r.prototype.as=function(n){return t[n]=this,this},r.prototype.concat=function(t){return this.push.apply(this,t),this},r.prototype.each=function(t){var r=new this.qType;return this.setHandler(function(e,i){i?n.isAsync(t,2)?t(e,function(){i(r.push.bind(r,e))}):(t(e),i(r.push.bind(r,e))):r[e]()}),r},r.prototype.eachAsync=n.makeAsync(r.prototype.each),r.prototype.eachSync=n.makeSync(r.prototype.each),r.prototype.wait=function(t){return this.each(function(e,r){typeof t=="function"?n.isAsync(t,2)?t(e,function(e){setTimeout(r,e)}):setTimeout(r,t(e)):setTimeout(r,t)})},r.prototype.waitAsync=n.makeAsync(r.prototype.wait),r.prototype.waitSync=n.makeSync(r.prototype.wait);var i=function(t,r,i){return this.setHandler(function(e,s){s?n.isAsync(i,2)?i(e,function(t){s(r.bind(this,e,t))}):s(r.bind(this,e,i(e))):t[e]()}),t};r.prototype.map=function(t){var n=new this.qType;return i.bind(this)(n,function(t,r){n.push(r)},t)},r.prototype.mapAsync=n.makeAsync(r.prototype.map),r.prototype.mapSync=n.makeSync(r.prototype.map),r.prototype.reduce=function(t,r,i){var s=i,o=undefined;return r||(o=new this.qType),this.setHandler(function(e,i){i?n.isAsync(t,3)?t(s,e,function(e){i(function(){s=e})}):i(function(){s=t(s,e)}):(!!r&&r instanceof Function&&r(s),!!r&&typeof r=="string"&&n(r).push(s),r||(o.push(s),o[e]()))}.bind(this)),o||this},r.prototype.reduceAsync=n.makeAsync(r.prototype.reduce),r.prototype.reduceSync=n.makeSync(r.prototype.reduce),r.prototype.filter=function(t){var n=new this.qType;return i.bind(this)(n,function(t,r){r&&n.push(t)},t)},r.prototype.filterAsync=n.makeAsync(r.prototype.filter),r.prototype.filterSync=n.makeSync(r.prototype.filter),r.prototype.branch=function(t){return this.setHandler(function(e,r){function i(t){typeof t=="string"?n(t).push(e):typeof t=="object"&&!!t.push&&t.push(e)}if(!!r)if(typeof t=="function"&&n.isAsync(t,2))t(e,function(e){r(function(){e instanceof Array?e.forEach(i):i(e)})});else if(typeof t=="function"){var s=t(e);r(function(){s instanceof Array?s.forEach(i):i(s)})}else t instanceof Array?r(function(){t.forEach(i)}):r(function(){i(t)})}.bind(this)),this},r.prototype.branchAsync=n.makeAsync(r.prototype.branch),r.prototype.branchSync=n.makeSync(r.prototype.branch);var s=function(t,r,i){function o(e,t){!t||t()}var s=undefined;return i||(s=new this.qType),this.setHandler(function(e,u){u?n.isAsync(r,2)?r(e,function(e){u(function(){e||(this.setHandler(o),i||s.push(t),!!i&&i instanceof Function&&i(t),!!i&&typeof i=="string"&&n(i).push(t))}.bind(this))}.bind(this)):u(function(){r(e)||(this.setHandler(o),i||s.push(t),!!i&&i instanceof Function&&i(t),!!i&&typeof i=="string"&&n(i).push(t))}.bind(this)):(i||s.push(!t),!!i&&i instanceof Function&&i(!t),!!i&&typeof i=="string"&&n(i).push(!t))}.bind(this)),s||this};return r.prototype.every=function(t,n){return s.bind(this,!1,t,n)()},r.prototype.everyAsync=n.makeAsync(r.prototype.every),r.prototype.everySync=n.makeSync(r.prototype.every),r.prototype.some=function(t,n){return s.bind(this,!0,t,n)()},r.prototype.someSync=n.makeAsync(r.prototype.some),r.prototype.someAsync=n.makeSync(r.prototype.some),r.prototype.toArray=function(t){return this.reduce(function(e,t){return e.push(t),e},t,[])},r.prototype.flatten=function(t){function r(e,i){e&&e instanceof Array?t&&typeof t=="number"&&t==i?n.push(e):e.forEach(function(e){r(e,i+1)}):n.push(e)}var n=new this.qType;return this.setHandler(function(e,t){t?t(function(){r(e,0)}):n[e]()}),n},r.prototype.node=function(t,r){var i=new this.qType;return this.setHandler(function(e,s){e instanceof Array||(e=[e]);if(!s)i[e]();else if(n.isAsync(t,e.length+1))e.push(u.bind(this,i,r,s,e)),t.apply(this,e);else try{u.bind(this)(i,r,s,e,undefined,t.apply(this,e))}catch(o){u.bind(this)(i,r,s,e,o)}}.bind(this)),i},r.prototype.nodeAsync=n.makeAsync(r.prototype.node),r.prototype.nodeSync=n.makeSync(r.prototype.node),r.prototype.exec=function(t,n){return a.bind(this,!1)(t,n)},r.prototype.execSync=function(t,n){return a.bind(this,"sync")(t,n)},r.prototype.execAsync=function(t,n){return a.bind(this,"async")(t,n)},r.prototype.subqueue=function(t){if(n.isAsync(t,2)){var r=new this.qType,i=new this.qType,s=[];return this.each(s.push.bind(s)),t(r,function(e){r.concat(s),e.branch(i)}),i}return t(this)},r.prototype.subqueueSync=n.makeSync(r.prototype.subqueue),r.prototype.subqueueAsync=n.makeAsync(r.prototype.subqueue),n}();module&&module.exports&&(module.exports=q);