var q=function qEnv(){if(typeof process=="undefined")process={};if(!process.nextTick)process.nextTick=function(func){setTimeout(func,0)};var namedQueues={};function q(nameOrArray,qType){if(typeof nameOrArray=="string"){if(!namedQueues[nameOrArray]||!(namedQueues[nameOrArray]instanceof q.defaultQ||namedQueues[nameOrArray]instanceof qType)){namedQueues[nameOrArray]=new Q(nameOrArray,qType||q.defaultQ)}return namedQueues[nameOrArray]}else if(nameOrArray instanceof Array){return new Q(nameOrArray,qType||q.defaultQ)}else{return new Q(undefined,qType||q.defaultQ)}}q.Q=Q;q.defaultQ=Q;q.ns=qEnv;q.exists=function exists(queueName){return!!namedQueues[queueName]&&typeof namedQueues[queueName]=="object"};q.makeAsync=function makeAsync(qfMethod){return function(){return qfMethod.apply(this,Array.prototype.slice.call(arguments,0).map(function(arg){if(arg instanceof Function)arg.async=true;return arg}))}};q.makeSync=function makeSync(qfMethod){return function(){return qfMethod.apply(this,Array.prototype.slice.call(arguments,0).map(function(arg){if(arg instanceof Function)arg.sync=true;return arg}))}};q.isAsync=function isAsync(method,asyncArgLength){return method.async||!method.sync&&method.length==asyncArgLength};q.tuple=function tuple(obj){return Object.keys(obj).reduce(function(outArr,key){return outArr.concat([[key,obj[key]]])},[])};function Q(nameOrArray,qType){this.qType=!!qType&&qType instanceof Function?qType:Q;var eventHandlers={};var queue=nameOrArray instanceof Array?nameOrArray:[];var handler;var handlerBusy=false;var recentlyEmptied=false;this.on=function on(eventName,handler){if(!eventHandlers)eventHandlers={};eventHandlers[eventName]=eventHandlers[eventName]instanceof Array?eventHandlers[eventName]:[];eventHandlers[eventName].push(handler);return this}.bind(this);this.fire=function fire(eventName){var newArgs=Array.prototype.slice.call(arguments,1,arguments.length-1);var callback=arguments[arguments.length-1]instanceof Function?arguments[arguments.length-1]:function(){};if(!eventHandlers){callback(false)}else if(eventHandlers[eventName]){var total=eventHandlers[eventName].length,count=0,finalResult=true;eventHandlers[eventName].forEach(function(newArgs,handler){if(!handler instanceof Function)return count++;if(q.isAsync(handler,newArgs.length+1)){newArgs.push(function(result){if(result===false)finalResult=result;count++;if(total==count)callback(finalResult)});handler.apply(this,newArgs)}else{var result=handler.apply(this,newArgs);if(result===false)finalResult=result;count++;if(total==count)callback(finalResult)}}.bind(this,newArgs))}else{callback(true)}}.bind(this);this.clear=function clear(eventName){eventHandlers[eventName]=[];return this}.bind(this);this.setHandler=function setHandler(handlerFunc){handler=handlerFunc;if(!handlerBusy)process.nextTick(handlerCallback.bind(this));return this}.bind(this);var handlerCallback=function handlerCallback(done){if(done instanceof Function)done();if(!handlerBusy&&queue&&queue.length>0){handlerBusy=true;this.fire("pull",queue[0],function(result){if(result&&handler instanceof Function){process.nextTick(function(){handler.bind(this,queue.shift(),function(done){handlerBusy=false;handlerCallback.bind(this)(done)}.bind(this))()}.bind(this))}}.bind(this))}else if(!handlerBusy&&!recentlyEmptied){this.fire("empty");recentlyEmptied=true}};this.push=function push(value){recentlyEmptied=false;var values=Array.prototype.slice.call(arguments,0);this.fire("push",values,function(result){if(result){Array.prototype.push.apply(queue,values);if(!handlerBusy)process.nextTick(handlerCallback.bind(this))}}.bind(this));return this}.bind(this);this.close=function close(){this.fire("close",function(result){if(result){this.clear("push");this.on("push",function(){return false});var flushQueue=function(){var tempHandler=handler;handler=undefined;eventHandlers=undefined;queue=undefined;Object.keys(namedQueues).forEach(function(queue){if(namedQueues[queue]===this)delete namedQueues[queue]}.bind(this));if(tempHandler instanceof Function){process.nextTick(tempHandler.bind(null,"close"))}};if(queue&&!queue.length)process.nextTick(flushQueue.bind(this));if(queue&&queue.length){this.clear("empty");this.on("empty",flushQueue.bind(this))}}}.bind(this));return this}.bind(this);this.kill=function kill(){this.fire("kill");var tempHandler=handler;handler=undefined;eventHandlers=undefined;queue=undefined;Object.keys(namedQueues).forEach(function(queue){if(namedQueues[queue]===this)delete namedQueues[queue]}.bind(this));if(tempHandler instanceof Function){tempHandler("kill")}}.bind(this);if(qType&&qType instanceof Function&&qType!==Q){var altObj=new qType(nameOrArray);altObj.namedQueues=namedQueues;return altObj}else{if(!handlerBusy)process.nextTick(handlerCallback.bind(this));if(queue.length>0)this.on("empty",this.close.bind(this));return this}}Q.prototype.as=function as(name){namedQueues[name]=this;return this};Q.prototype.concat=function concat(array){this.push.apply(this,array);return this};Q.prototype.each=function each(callback){var outQueue=new this.qType;this.setHandler(function(value,next){if(!next){outQueue[value]()}else{if(q.isAsync(callback,2)){callback(value,function(){next(outQueue.push.bind(outQueue,value))})}else{callback(value);next(outQueue.push.bind(outQueue,value))}}});return outQueue};Q.prototype.eachAsync=q.makeAsync(Q.prototype.each);Q.prototype.eachSync=q.makeSync(Q.prototype.each);Q.prototype.wait=function wait(delay){return this.each(function(val,callback){if(typeof delay=="function"){if(q.isAsync(delay,2)){delay(val,function(delay){setTimeout(callback,delay)})}else{setTimeout(callback,delay(val))}}else{setTimeout(callback,delay)}})};Q.prototype.waitAsync=q.makeAsync(Q.prototype.wait);Q.prototype.waitSync=q.makeSync(Q.prototype.wait);var inOut=function inOut(outQueue,setter,callback){this.setHandler(function(value,next){if(!next){outQueue[value]()}else{if(q.isAsync(callback,2)){callback(value,function(result){next(setter.bind(this,value,result))})}else{next(setter.bind(this,value,callback(value)))}}});return outQueue};Q.prototype.map=function map(callback){var outQueue=new this.qType;return inOut.bind(this)(outQueue,function mapSetter(value,result){outQueue.push(result)},callback)};Q.prototype.mapAsync=q.makeAsync(Q.prototype.map);Q.prototype.mapSync=q.makeSync(Q.prototype.map);Q.prototype.reduce=function reduce(callback,last,initial){var out=initial;var outQueue;if(!last)outQueue=new this.qType;this.setHandler(function(value,next){if(!next){if(!!last&&last instanceof Function)last(out);if(!!last&&typeof last=="string")q(last).push(out);if(!last)outQueue.push(out),outQueue[value]()}else{if(q.isAsync(callback,3)){callback(out,value,function(result){next(function(){out=result})})}else{next(function(){out=callback(out,value)})}}}.bind(this));return outQueue||this};Q.prototype.reduceAsync=q.makeAsync(Q.prototype.reduce);Q.prototype.reduceSync=q.makeSync(Q.prototype.reduce);Q.prototype.filter=function filter(callback){var outQueue=new this.qType;return inOut.bind(this)(outQueue,function filterSetter(value,result){if(result)outQueue.push(value)},callback)};Q.prototype.filterAsync=q.makeAsync(Q.prototype.filter);Q.prototype.filterSync=q.makeSync(Q.prototype.filter);Q.prototype.branch=function branch(callback){this.setHandler(function(value,next){function queueProcessor(queue){if(typeof queue=="string"){q(queue).push(value)}else if(typeof queue=="object"&&!!queue.push){queue.push(value)}}if(!!next){if(typeof callback=="function"&&q.isAsync(callback,2)){callback(value,function(result){next(function(){if(result instanceof Array){result.forEach(queueProcessor)}else{queueProcessor(result)}})})}else if(typeof callback=="function"){var result=callback(value);next(function(){if(result instanceof Array){result.forEach(queueProcessor)}else{queueProcessor(result)}})}else if(callback instanceof Array){next(function(){callback.forEach(queueProcessor)})}else{next(function(){queueProcessor(callback)})}}}.bind(this));return this};Q.prototype.branchAsync=q.makeAsync(Q.prototype.branch);Q.prototype.branchSync=q.makeSync(Q.prototype.branch);var everySome=function everySome(polarity,callback,last){var outQueue;if(!last)outQueue=new this.qType;function shortCircuit(value,next){if(!!next)next()}this.setHandler(function(value,next){if(!next){if(!last)outQueue.push(!polarity);if(!!last&&last instanceof Function)last(!polarity);if(!!last&&typeof last=="string")q(last).push(!polarity)}else{if(q.isAsync(callback,2)){callback(value,function(result){next(function(){if(!result){this.setHandler(shortCircuit);if(!last)outQueue.push(polarity);if(!!last&&last instanceof Function)last(polarity);if(!!last&&typeof last=="string")q(last).push(polarity)}}.bind(this))}.bind(this))}else{next(function(){if(!callback(value)){this.setHandler(shortCircuit);if(!last)outQueue.push(polarity);if(!!last&&last instanceof Function)last(polarity);if(!!last&&typeof last=="string")q(last).push(polarity)}}.bind(this))}}}.bind(this));return outQueue||this};Q.prototype.every=function every(callback,last){return everySome.bind(this,false,callback,last)()};Q.prototype.everyAsync=q.makeAsync(Q.prototype.every);Q.prototype.everySync=q.makeSync(Q.prototype.every);Q.prototype.some=function some(callback,last){return everySome.bind(this,true,callback,last)()};Q.prototype.someSync=q.makeAsync(Q.prototype.some);Q.prototype.someAsync=q.makeSync(Q.prototype.some);Q.prototype.toArray=function toArray(last){return this.reduce(function(cumm,value){cumm.push(value);return cumm},last,[])};Q.prototype.flatten=function flatten(depth){var outQueue=new this.qType;function processValue(value,currDepth){if(value&&value instanceof Array){if(depth&&typeof depth=="number"&&depth==currDepth){outQueue.push(value)}else{value.forEach(function(value){processValue(value,currDepth+1)})}}else{outQueue.push(value)}}this.setHandler(function(value,next){if(!next){outQueue[value]()}else{next(function(){processValue(value,0)})}});return outQueue};function shortCircuit(value,next){if(!!next)next()}function ercb(outQueue,onError,next,value,error,result){if(!error){next(function(){outQueue.push(result)})}else{if(!onError){}else if(onError instanceof Function){this.setHandler(shortCircuit);onError(error,result,value)}else if(typeof onError=="string"){next(function(){q(onError).push([error,result,value])})}else if(typeof onError=="object"){next(function(){onError.push([error,result,value])})}else{this.setHandler(shortCircuit)}}}Q.prototype.node=function node(callback,onError){var outQueue=new this.qType;this.setHandler(function(value,next){if(!(value instanceof Array))value=[value];if(!next){outQueue[value]()}else{if(q.isAsync(callback,value.length+1)){value.push(ercb.bind(this,outQueue,onError,next,value));callback.apply(this,value)}else{try{ercb.bind(this)(outQueue,onError,next,value,undefined,callback.apply(this,value))}catch(e){ercb.bind(this)(outQueue,onError,next,value,e)}}}}.bind(this));return outQueue};Q.prototype.nodeAsync=q.makeAsync(Q.prototype.node);Q.prototype.nodeSync=q.makeSync(Q.prototype.node);function execCommon(forceSyncAsync,args,onError){var outQueue=new this.qType;this.setHandler(function(value,next){if(!next)return outQueue[value]();if(!(value instanceof Function))return ercb(outQueue,onError,next,value,new Error("Not a function"),undefined);function execFunc(args){if(forceSyncAsync=="async"||forceSyncAsync!="sync"&&q.isAsync(value,args.length+1)){args.push(ercb.bind(this,outQueue,onError,next,value));value.apply(this,args)}else{try{ercb(outQueue,onError,next,value,undefined,value.apply(this,args))}catch(e){ercb(outQueue,onError,next,value,e)}}}if(args instanceof Function&&q.isAsync(args,2)){args(value,function(){execFunc.bind(this)(Array.prototype.slice.call(arguments,0))})}else if(args instanceof Function){try{var args2=args(value);args2=args2 instanceof Array?args2:[args2];execFunc.bind(this)(args2)}catch(e){ercb.bind(this)(outQueue,onError,next,value,e)}}else if(args instanceof Array){execFunc.bind(this)(args)}else{execFunc.bind(this)([args])}}.bind(this));return outQueue}Q.prototype.exec=function exec(args,onError){return execCommon.bind(this,false)(args,onError)};Q.prototype.execSync=function execSync(args,onError){return execCommon.bind(this,"sync")(args,onError)};Q.prototype.execAsync=function execAsync(args,onError){return execCommon.bind(this,"async")(args,onError)};Q.prototype.subqueue=function subqueue(callback){if(q.isAsync(callback,2)){var inQueue=new this.qType;var outQueue=new this.qType;var buffer=[];this.each(buffer.push.bind(buffer));callback(inQueue,function(intermediateQ){inQueue.concat(buffer);intermediateQ.branch(outQueue)});return outQueue}else{return callback(this)}};Q.prototype.subqueueSync=q.makeSync(Q.prototype.subqueue);Q.prototype.subqueueAsync=q.makeAsync(Q.prototype.subqueue);Q.prototype.promise=function promise(callback,error){var outQueue=new this.qType;if(typeof error=="string"){error=q(error).push.bind(q(error))}else if(typeof error=="object"){error=error.push.bind(error)}else if(typeof error=="function"){}else{error=function(){}}this.setHandler(function(value,next){if(!next)return outQueue[value]();if(!(value instanceof Array))value=[value];callback.apply(this,value).then(function(result){next(function(){outQueue.push(result)})},error)});return outQueue};Q.prototype.promiseAsync=Q.prototype.promise;Q.prototype.promiseSync=function(){throw"Synchronous Promises are Nonsensical!"};Q.prototype.drain=function drain(){this.setHandler(function(value,next){if(next&&next instanceof Function)next(function(){})});return undefined};return q}();if(typeof module!="undefined"&&module.exports){module.exports=q}