// queue-flow Copyright (C) 2012 by David Ellis
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// Construct the `q` environment and return the `q` accessor/constructor object
var q=function e(){function n(e,n){if(typeof e=="string"){if(!t[e]||!(t[e]instanceof r||t[e]instanceof n))t[e]=new r(e,n);return t[e]}return e instanceof Array?new r(e,n):new r(undefined,n)}function r(e,n){this.qType=!!n&&n instanceof Function?n:r;var i={},s=e instanceof Array?e:[],o=undefined,u=!1,a=!1,f=!1;this.on=function(t,n){return i||(i={}),i[t]=i[t]instanceof Array?i[t]:[],i[t].push(n),this},this.fire=function(t){var n=Array.prototype.slice.call(arguments,1);return i?i[t]?i[t].every(function(e){return e instanceof Function?e.apply(this,n)!==!1:!0}.bind(this)):!0:!1},this.clear=function(t){i[t]=[]},this.setHandler=function(t){return o=t,process.nextTick(l.bind(this)),this};var l=function c(){u=!1;if(s&&s.length>0){var e=s[0];this.fire("pull",e)&&o instanceof Function&&(u=!0,process.nextTick(o.bind(this,s.shift(),c.bind(this))))}else o instanceof Function&&!!this&&(f||(this.fire("empty"),f=!0),a&&this.close())};return this.push=function(t){f=!1;var n=Array.prototype.slice.call(arguments,0);return this.fire("push",n)&&(Array.prototype.push.apply(s,n),process.nextTick(l.bind(this))),this},this.close=function(){if(u)a=!0;else if(this.fire("close")){this.clear("close"),this.on("close",function(){return!1});function n(){if(s&&s.length>0&&o instanceof Function){var e=s[0];this.fire("pull",e)&&process.nextTick(o.bind(this,s.shift(),n))}else process.nextTick(function(){var e=o;o=undefined,i=undefined,s=undefined,Object.keys(t).forEach(function(e){t[e]===this&&delete t[e]}.bind(this)),delete this,e instanceof Function&&process.nextTick(e.bind(null,"close"))}.bind(this),0)}process.nextTick(n.bind(this))}},this.kill=function(){this.fire("kill");var n=o;o=undefined,i=undefined,s=undefined,Object.keys(t).forEach(function(e){t[e]===this&&delete t[e]}.bind(this)),delete this,n instanceof Function&&n("kill")},n&&n instanceof Function?new n(e):(process.nextTick(l.bind(this)),s.length>0&&this.closeOnEmpty(),this)}var t={};if(!process||!process.nextTick)process=process||{},process.nextTick=process.nextTick||setTimeout;n.exists=function(n){return!!t[n]&&typeof t[n]=="object"},n.cps=n.async=function(t){return t.async=!0,t},n.isAsync=function(t,n){return t.async||t.length==n},n.Q=r,n.ns=e,n.tuple=function(t){return Object.keys(t).reduce(function(e,n){return e.concat([[n,t[n]]])},[])},r.prototype.as=function(n){return t[n]=this,this.clear("empty"),this},r.prototype.closeOnEmpty=function(){return this.on("empty",process.nextTick.bind(this,this.close.bind(this))),this},r.prototype.load=function(t){return this.push.apply(this,t),this},r.prototype.each=function(t){var n=new this.qType;return this.setHandler(function(e,r){r?(t(e),n.push(e),r()):n[e]()}),n};var i=function(t,n,r){t(r),n()},s=function(t,r,s){return this.setHandler(function(e,o){o?n.isAsync(s,2)?s(e,i.bind(this,r.bind(this,e),o)):i(r.bind(this,e),o,s(e)):t[e]()}),t};r.prototype.map=function(t){var n=new this.qType;return s.bind(this)(n,function(t,r){n.push(r)},t)},r.prototype.reduce=function(t,r,s){var o=s,u=undefined;return r||(u=new this.qType),this.setHandler(function(e,s){s?n.isAsync(t,3)?t(o,e,i.bind(this,function(e){o=e},s)):(o=t(o,e),s()):(!!r&&r instanceof Function&&r(o),!!r&&typeof r=="string"&&n(r).push(o),r||(u.push(o),u[e]()))}.bind(this)),u||this},r.prototype.filter=function(t){var n=new this.qType;return s.bind(this)(n,function(t,r){r&&n.push(t)},t)},r.prototype.branch=function(t){return this.setHandler(function(e,r){if(!!r)if(n.isAsync(t,2))t(e,i.bind(this,function(t){n(t).push(e)},r));else{var s=t(e);n(s).push(e),r()}}.bind(this)),this};var o=function(t,r,i){function o(e,t){!t||t()}var s=undefined;return i||(s=new this.qType),this.setHandler(function(e,u){u?n.isAsync(r,2)?r(e,function(e){e||(this.setHandler(o),i||s.push(t),!!i&&i instanceof Function&&i(t),!!i&&typeof i=="string"&&n(i).push(t)),u()}):(r(e)||(this.setHandler(o),i||s.push(t),!!i&&i instanceof Function&&i(t),!!i&&typeof i=="string"&&n(i).push(t)),u()):(i||s.push(!t),!!i&&i instanceof Function&&i(!t),!!i&&typeof i=="string"&&n(i).push(!t))}.bind(this)),s||this};return r.prototype.every=function(t,n){return o.bind(this,!1,t,n)()},r.prototype.some=function(t,n){return o.bind(this,!0,t,n)()},r.prototype.toArray=function(t){return this.reduce(function(e,t){return e.push(t),e},t,[])},r.prototype.flatten=function(t){function r(e,i){e&&e instanceof Array?t&&typeof t=="number"&&t==i?n.push(e):e.forEach(function(e){r(e,i+1)}):n.push(e)}var n=new this.qType;return this.setHandler(function(e,t){t?(r(e,0),t()):n[e]()}),n},r.prototype.exec=function(t,r){function s(e,t){!t||t()}function o(e,t,o,u){o?!r||(r instanceof Function?(this.setHandler(s),r(o,u,t)):typeof r=="string"&&u!=undefined?(n(r).push([o,u,t]),e()):typeof r=="string"?(n(r).push([o,undefined,t]),e()):this.setHandler(s)):(i.push(u),e())}var i=new this.qType;return this.setHandler(function(e,r){e instanceof Array||(e=[e]);if(!r)i[e]();else{if(!n.isAsync(t,e.length+1)){var s;try{s=t.apply(this,e)}catch(u){return o(r,e,u)}return o(r,e,undefined,s)}e.push(o.bind(this,r,e)),t.apply(this,e)}}.bind(this)),i},r.prototype.chain=function(t){return this.branch(function(){return t}),this},n}();module&&module.exports&&(module.exports=q);