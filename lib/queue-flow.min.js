// queue-flow Copyright (C) 2012 by David Ellis
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// Construct the `q` environment and return the `q` accessor/constructor object
var q=function(){function n(e,n){if(typeof e=="string"){if(!t[e]||!(t[e]instanceof r||t[e]instanceof n))t[e]=new r(e,n);return t[e]}return e instanceof Array?new r(e,n):new r(undefined,n)}function r(e,t){var n=this;this.qType=!!t&&t instanceof Function?t:r;var i={},s=e instanceof Array?e:[],o=undefined;this.on=function(t,n){return i||(i={}),i[t]=i[t]instanceof Array?i[t]:[],i[t].push(n),this},this.fire=function(t){var r=Array.prototype.slice.call(arguments,1);return i?i[t]?i[t].every(function(e){return e instanceof Function?e.apply(n,r)!==!1:!0}):!0:!1},this.clear=function(t){i[t]=[]},this.each=this.setHandler=function(t){return o=t,setTimeout(u,0),this};var u=function a(){if(s&&s.length>0){var e=s[0];n.fire("pull",e)&&o instanceof Function&&setTimeout(o.bind(n,s.shift(),a),0)}else o instanceof Function&&!!n&&n.fire("empty")};return this.push=function(t){var n=Array.prototype.slice.call(arguments,0);return this.fire("push",n)&&(Array.prototype.push.apply(s,n),setTimeout(u,0)),this},this.close=function(){if(this.fire("close")){this.clear("close"),this.on("close",function(){return!1});function t(){if(s&&s.length>0&&o instanceof Function){var e=s[0];this.fire("pull",e)&&setTimeout(o.bind(this,s.shift(),t),0)}else setTimeout(function(){o instanceof Function&&o("close"),i=undefined,s=undefined,o=undefined,n=undefined,delete this},0)}setTimeout(t.bind(this),0)}},t&&t instanceof Function&&(this=new t(e)),setTimeout(u,0),s.length>0&&this.closeOnEmpty(),this}var t={};n.cps=n.async=function(t){return t.async=!0,t},n.Q=r,r.prototype.as=function(n){return t[n]=this,this.clear("empty"),this},r.prototype.closeOnEmpty=function(){return setTimeout(function(){this.on("empty",this.close)}.bind(this),0),this};var i=function(t,n,r){t(r),n()},s=function(t,n,r){return this.setHandler(function(e,s){s?r.async?r(e,i.bind(this,n.bind(this,e),s)):i(n.bind(this,e),s,r(e)):t.close()}),t};r.prototype.map=function(t){var n=new this.qType;return s.bind(this)(n,function(t,r){n.push(r)},t)},r.prototype.reduce=function(t,n,r){var s=r;return this.setHandler(function(e,r){r?t.async?t(s,e,i.bind(this,function(e){s=e},r)):(s=t(s,e),r()):!n||n(s)}.bind(this)),this},r.prototype.filter=function(t){var n=new this.qType;return s.bind(this)(n,function(t,r){r&&n.push(t)},t)},r.prototype.branch=function(t){var r={};return this.setHandler(function(e,s){if(!s)Object.keys(r).forEach(function(e){n(e).close()});else if(t.async)t(e,i.bind(this,function(t){r[t]=!0,n(t).push(e)},s));else{var o=t(e);r[o]=!0,n(o).push(e),s()}}.bind(this)),this};var o=function(t,n,r){function i(e,t){!t||t()}return this.setHandler(function(e,s){s?n.async?n(e,function(e){!e&&!!r&&(this.setHandler(i),r(t)),s()}):(!n(e)&&!!r&&(this.setHandler(i),r(t)),s()):!r||r(!t)}.bind(this)),this};return r.prototype.every=function(t,n){return o.bind(this,!1,t,n)()},r.prototype.some=function(t,n){return o.bind(this,!0,t,n)()},r.prototype.toArray=function(t){return this.reduce(function(e,t){return e.push(t),e},t,[]),this},n}();module&&module.exports&&(module.exports=q);